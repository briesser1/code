# ==============================================================================
# Parse CFSR Item 5 Extraction JSON
# Development & Testing Script
#
# Purpose: Parse the two-layer JSON output from the CFSR Item 5 prompt
#          (theme extraction + semantic relationship map) into tidy dataframes
#
# Item 5: Did the agency establish appropriate permanency goals for the child
#         in a timely manner?
#
# Input:   JSON string or file from LLM response
# Output:  Five tidy dataframes ready for analysis
# ==============================================================================

library(jsonlite)
library(tidyverse)

# ------------------------------------------------------------------------------
# SAMPLE JSON FOR TESTING
# Replace this with actual LLM output when testing against real narratives
# ------------------------------------------------------------------------------

sample_json <- '{
  "theme_extraction": {
    "case_summary": "The agency established reunification as the initial permanency goal timely but failed to pursue concurrent planning. When the mother did not complete services by month 12, the goal was changed to adoption, but TPR was not filed until month 18, delaying permanency for the child.",
    "item_rating": "area_needing_improvement",
    "permanency_goal": "adoption",
    "themes": [
      {
        "theme_id": "T1",
        "theme": "goal_timeliness",
        "finding": "strength",
        "excerpt": "Agency established reunification as the permanency goal within 60 days of the childs entry into care, meeting federal timeliness requirements.",
        "actor": "agency",
        "timeframe": "initial"
      },
      {
        "theme_id": "T2",
        "theme": "concurrent_planning",
        "finding": "concern",
        "excerpt": "No concurrent plan was documented or pursued during the first 10 months of the case despite minimal parental engagement.",
        "actor": "agency",
        "timeframe": "ongoing"
      },
      {
        "theme_id": "T3",
        "theme": "parent_engagement",
        "finding": "concern",
        "excerpt": "Mother attended only 3 of 12 scheduled treatment sessions and missed multiple visitation appointments without explanation.",
        "actor": "birth_parent",
        "timeframe": "ongoing"
      },
      {
        "theme_id": "T4",
        "theme": "tpr_timeliness",
        "finding": "concern",
        "excerpt": "TPR was not filed until month 18, three months past the 15-of-22-months threshold, delaying the childs path to adoption.",
        "actor": "agency",
        "timeframe": "at_permanency_hearing"
      },
      {
        "theme_id": "T5",
        "theme": "adoption_efforts",
        "finding": "strength",
        "excerpt": "Foster parents expressed commitment to adoption early in the case and have been engaged in adoption preparation activities.",
        "actor": "foster_parent",
        "timeframe": "ongoing"
      },
      {
        "theme_id": "T6",
        "theme": "relative_search",
        "finding": "neutral",
        "excerpt": "Agency completed relative search within 30 days but no appropriate relatives were identified or willing to be placement resources.",
        "actor": "agency",
        "timeframe": "initial"
      },
      {
        "theme_id": "T7",
        "theme": "court_coordination",
        "finding": "concern",
        "excerpt": "Permanency hearing was continued twice due to incomplete agency documentation, adding to case delays.",
        "actor": "agency",
        "timeframe": "at_12_months"
      }
    ],
    "primary_concerns": [
      "Lack of concurrent planning despite minimal parental progress",
      "TPR filing delayed past 15-of-22-months requirement",
      "Court continuances due to incomplete documentation"
    ],
    "primary_strengths": [
      "Timely initial permanency goal establishment",
      "Committed foster family willing to adopt"
    ]
  },
  "relationship_map": {
    "semantic_objects": [
      {
        "object_id": "S1",
        "label": "mothers failure to engage in services",
        "object_type": "condition",
        "sentiment": "negative"
      },
      {
        "object_id": "S2",
        "label": "lack of concurrent planning",
        "object_type": "action",
        "sentiment": "negative"
      },
      {
        "object_id": "S3",
        "label": "delayed TPR filing at month 18",
        "object_type": "event",
        "sentiment": "negative"
      },
      {
        "object_id": "S4",
        "label": "delayed permanency for child",
        "object_type": "state",
        "sentiment": "negative"
      },
      {
        "object_id": "S5",
        "label": "foster parent adoption commitment",
        "object_type": "state",
        "sentiment": "positive"
      },
      {
        "object_id": "S6",
        "label": "timely initial goal establishment",
        "object_type": "action",
        "sentiment": "positive"
      },
      {
        "object_id": "S7",
        "label": "reunification goal",
        "object_type": "goal",
        "sentiment": "neutral"
      },
      {
        "object_id": "S8",
        "label": "goal change to adoption at month 12",
        "object_type": "event",
        "sentiment": "neutral"
      },
      {
        "object_id": "S9",
        "label": "court continuances",
        "object_type": "event",
        "sentiment": "negative"
      },
      {
        "object_id": "S10",
        "label": "incomplete agency documentation",
        "object_type": "condition",
        "sentiment": "negative"
      }
    ],
    "relationships": [
      {
        "source_object_id": "S1",
        "source_label": "mothers failure to engage in services",
        "relationship_type": "contributes_to",
        "target_object_id": "S8",
        "target_label": "goal change to adoption at month 12",
        "related_themes": ["T3"],
        "confidence": "high",
        "directionality": "explicit"
      },
      {
        "source_object_id": "S2",
        "source_label": "lack of concurrent planning",
        "relationship_type": "delays",
        "target_object_id": "S8",
        "target_label": "goal change to adoption at month 12",
        "related_themes": ["T2"],
        "confidence": "medium",
        "directionality": "inferred"
      },
      {
        "source_object_id": "S3",
        "source_label": "delayed TPR filing at month 18",
        "relationship_type": "delays",
        "target_object_id": "S4",
        "target_label": "delayed permanency for child",
        "related_themes": ["T4"],
        "confidence": "high",
        "directionality": "explicit"
      },
      {
        "source_object_id": "S5",
        "source_label": "foster parent adoption commitment",
        "relationship_type": "supports",
        "target_object_id": "S4",
        "target_label": "delayed permanency for child",
        "related_themes": ["T5"],
        "confidence": "medium",
        "directionality": "inferred"
      },
      {
        "source_object_id": "S6",
        "source_label": "timely initial goal establishment",
        "relationship_type": "addresses",
        "target_object_id": "S7",
        "target_label": "reunification goal",
        "related_themes": ["T1"],
        "confidence": "high",
        "directionality": "explicit"
      },
      {
        "source_object_id": "S1",
        "source_label": "mothers failure to engage in services",
        "relationship_type": "undermines",
        "target_object_id": "S7",
        "target_label": "reunification goal",
        "related_themes": ["T3"],
        "confidence": "high",
        "directionality": "inferred"
      },
      {
        "source_object_id": "S10",
        "source_label": "incomplete agency documentation",
        "relationship_type": "causes",
        "target_object_id": "S9",
        "target_label": "court continuances",
        "related_themes": ["T7"],
        "confidence": "high",
        "directionality": "explicit"
      },
      {
        "source_object_id": "S9",
        "source_label": "court continuances",
        "relationship_type": "contributes_to",
        "target_object_id": "S4",
        "target_label": "delayed permanency for child",
        "related_themes": ["T7", "T4"],
        "confidence": "medium",
        "directionality": "inferred"
      }
    ]
  }
}'


# ==============================================================================
# PARSING FUNCTIONS
# ==============================================================================

#' Parse the full CFSR Item 5 JSON extraction into tidy dataframes
#'
#' @param json_string Character string of JSON from LLM response
#' @param case_id     Optional case identifier to attach to all rows
#' @return Named list of five dataframes:
#'         themes, concerns_strengths, semantic_objects, relationships, rel_themes
parse_cfsr_item5_extraction <- function(json_string, case_id = NA_character_) {

  # -- Parse JSON ---------------------------------------------------------------
  parsed <- tryCatch(
    fromJSON(json_string, flatten = TRUE),
    error = function(e) {
      warning("JSON parse failed: ", e$message)
      return(NULL)
    }
  )

  if (is.null(parsed)) {
    warning("Returning empty dataframes for case: ", case_id)
    return(empty_result_item5(case_id))
  }

  te <- parsed$theme_extraction
  rm <- parsed$relationship_map

  # -- 1. Themes ----------------------------------------------------------------
  themes <- te$themes |>
    as_tibble() |>
    mutate(
      case_id         = case_id,
      item_rating     = te$item_rating,
      permanency_goal = te$permanency_goal,
      case_summary    = te$case_summary,
      .before = 1
    )

  # -- 2. Concerns & Strengths (long format) ------------------------------------
  concerns_strengths <- bind_rows(
    tibble(case_id = case_id, type = "concern",  value = te$primary_concerns),
    tibble(case_id = case_id, type = "strength", value = te$primary_strengths)
  )

  # -- 3. Semantic Objects ------------------------------------------------------
  semantic_objects <- rm$semantic_objects |>
    as_tibble() |>
    mutate(case_id = case_id, .before = 1)

  # -- 4. Relationships (edge list) ---------------------------------------------
  relationships <- rm$relationships |>
    as_tibble() |>
    mutate(case_id = case_id, .before = 1)

  # Handle related_themes â€” it comes in as a list column
  # Keep it as-is for the main table; we'll explode it separately
  if ("related_themes" %in% names(relationships)) {
    relationships <- relationships |>
      mutate(
        related_themes_flat = map_chr(related_themes, ~ paste(.x, collapse = ", "))
      )
  }

  # -- 5. Relationship-to-Theme bridge (one row per theme per relationship) -----
  rel_themes <- relationships |>
    select(case_id, source_label, relationship_type, target_label, related_themes) |>
    unnest(related_themes) |>
    rename(related_theme_id = related_themes)

  # -- Return -------------------------------------------------------------------
  list(
    themes             = themes,
    concerns_strengths = concerns_strengths,
    semantic_objects   = semantic_objects,
    relationships      = relationships |> select(-related_themes),
    rel_themes         = rel_themes
  )
}


#' Return empty dataframes with correct structure when parsing fails
empty_result_item5 <- function(case_id = NA_character_) {
  list(
    themes = tibble(
      case_id = character(), item_rating = character(), permanency_goal = character(),
      case_summary = character(), theme_id = character(), theme = character(),
      finding = character(), excerpt = character(), actor = character(),
      timeframe = character()
    ),
    concerns_strengths = tibble(
      case_id = character(), type = character(), value = character()
    ),
    semantic_objects = tibble(
      case_id = character(), object_id = character(), label = character(),
      object_type = character(), sentiment = character()
    ),
    relationships = tibble(
      case_id = character(), source_object_id = character(),
      source_label = character(), relationship_type = character(),
      target_object_id = character(), target_label = character(),
      confidence = character(), directionality = character(),
      related_themes_flat = character()
    ),
    rel_themes = tibble(
      case_id = character(), source_label = character(),
      relationship_type = character(), target_label = character(),
      related_theme_id = character()
    )
  )
}


# ==============================================================================
# BATCH PARSING (for processing multiple cases)
# ==============================================================================

#' Parse multiple JSON extractions and combine into unified dataframes
#'
#' @param json_vector  Named character vector (names = case_ids, values = JSON)
#' @return Named list of five combined dataframes
parse_item5_batch <- function(json_vector) {

  results <- imap(json_vector, ~ {
    cat("Parsing case:", .y, "\n")
    parse_cfsr_item5_extraction(.x, case_id = .y)
  })

  list(
    themes             = map_dfr(results, "themes"),
    concerns_strengths = map_dfr(results, "concerns_strengths"),
    semantic_objects   = map_dfr(results, "semantic_objects"),
    relationships      = map_dfr(results, "relationships"),
    rel_themes         = map_dfr(results, "rel_themes")
  )
}


# ==============================================================================
# TEST: Parse the sample JSON
# ==============================================================================

cat("=" |> strrep(70), "\n")
cat("PARSING SAMPLE JSON - CFSR ITEM 5 (Permanency Goals)\n")
cat("=" |> strrep(70), "\n\n")

result <- parse_cfsr_item5_extraction(sample_json, case_id = "CASE-2025-001")

# -- Inspect each table --------------------------------------------------------

cat("--- CASE SUMMARY ---\n")
cat("Rating:", unique(result$themes$item_rating), "\n")
cat("Permanency Goal:", unique(result$themes$permanency_goal), "\n")
cat("Summary:", unique(result$themes$case_summary), "\n\n")

cat("--- THEMES ---\n")
result$themes |>
  select(case_id, theme_id, theme, finding, actor, timeframe) |>
  print(n = Inf)

cat("\n--- CONCERNS & STRENGTHS ---\n")
result$concerns_strengths |>
  print(n = Inf)

cat("\n--- SEMANTIC OBJECTS ---\n")
result$semantic_objects |>
  print(n = Inf)

cat("\n--- RELATIONSHIPS (Edge List) ---\n")
result$relationships |>
  select(source_label, relationship_type, target_label, confidence, directionality) |>
  print(n = Inf)

cat("\n--- RELATIONSHIP-THEME BRIDGE ---\n")
result$rel_themes |>
  print(n = Inf)


# ==============================================================================
# QUICK ANALYSIS EXAMPLES - ITEM 5 SPECIFIC
# ==============================================================================

cat("\n")
cat("=" |> strrep(70), "\n")
cat("ANALYSIS EXAMPLES - PERMANENCY GOALS\n")
cat("=" |> strrep(70), "\n\n")

# -- Theme distribution --------------------------------------------------------
cat("--- Theme Distribution ---\n")
result$themes |>
  count(theme, finding) |>
  arrange(desc(n)) |>
  print()

# -- Timeliness-related themes -------------------------------------------------
cat("\n--- Timeliness-Related Themes ---\n")
result$themes |>
  filter(str_detect(theme, "timeliness|concurrent")) |>
  select(theme_id, theme, finding, excerpt) |>
  print(n = Inf, width = 100)

# -- Barriers to permanency (delays/prevents/undermines) -----------------------
cat("\n--- Barriers to Permanency ---\n")
result$relationships |>
  filter(relationship_type %in% c("delays", "prevents", "undermines")) |>
  select(source_label, relationship_type, target_label, confidence) |>
  print(n = Inf)

# -- Supports/facilitates permanency -------------------------------------------
cat("\n--- Factors Supporting Permanency ---\n")
result$relationships |>
  filter(relationship_type %in% c("supports", "enables", "addresses")) |>
  select(source_label, relationship_type, target_label, confidence) |>
  print(n = Inf)

# -- Root cause analysis: what drives delays? ----------------------------------
cat("\n--- Root Causes of Delays (objects that appear as sources) ---\n")
outgoing <- result$relationships |>
  filter(relationship_type %in% c("delays", "causes", "contributes_to", "undermines")) |>
  count(source_label, name = "causes_delays")

outgoing |>
  left_join(
    result$semantic_objects |> select(label, object_type, sentiment),
    by = c("source_label" = "label")
  ) |>
  arrange(desc(causes_delays)) |>
  print()

# -- Causal chain visualization ------------------------------------------------
cat("\n--- Causal Chain: Trace from 'mothers failure to engage' ---\n")

trace_chain <- function(edges, start_label, depth = 0, max_depth = 5) {
  if (depth >= max_depth) return(invisible(NULL))

  next_edges <- edges |>
    filter(source_label == start_label)

  if (nrow(next_edges) == 0) return(invisible(NULL))

  for (i in seq_len(nrow(next_edges))) {
    edge <- next_edges[i, ]
    indent <- "  " |> strrep(depth)
    cat(sprintf(
      "%s%s -[%s]-> %s (%s, %s)\n",
      indent,
      edge$source_label,
      edge$relationship_type,
      edge$target_label,
      edge$confidence,
      edge$directionality
    ))
    trace_chain(edges, edge$target_label, depth + 1, max_depth)
  }
}

trace_chain(result$relationships, "mothers failure to engage in services")


# ==============================================================================
# ITEM 5 SPECIFIC ANALYSIS: PERMANENCY TIMELINE
# ==============================================================================

cat("\n")
cat("=" |> strrep(70), "\n")
cat("PERMANENCY TIMELINE ANALYSIS\n")
cat("=" |> strrep(70), "\n\n")

# Check for timeline-related semantic objects
cat("--- Timeline-Related Objects ---\n")
result$semantic_objects |>
  filter(object_type %in% c("timeline", "event") |
         str_detect(label, "month|delay|timely|15|22|12")) |>
  print(n = Inf)

# Summarize key permanency milestones
cat("\n--- Key Permanency Events ---\n")
result$themes |>
  filter(timeframe %in% c("at_12_months", "at_permanency_hearing", "initial")) |>
  select(theme_id, theme, finding, timeframe, excerpt) |>
  print(n = Inf, width = 100)


# ==============================================================================
# BATCH EXAMPLE (simulating multiple cases)
# ==============================================================================

cat("\n")
cat("=" |> strrep(70), "\n")
cat("BATCH PARSING EXAMPLE\n")
cat("=" |> strrep(70), "\n\n")

# Simulate a batch with 2 copies (in practice these are different cases)
batch_input <- c(
  "CASE-2025-001" = sample_json,
  "CASE-2025-002" = sample_json  # would be different JSON in production
)

batch_result <- parse_item5_batch(batch_input)

cat("\nBatch themes rows:", nrow(batch_result$themes), "\n")
cat("Batch relationships rows:", nrow(batch_result$relationships), "\n")
cat("Batch semantic objects rows:", nrow(batch_result$semantic_objects), "\n")

# Cross-case analysis example
cat("\n--- Cross-Case: Permanency Goal Distribution ---\n")
batch_result$themes |>
  distinct(case_id, permanency_goal, item_rating) |>
  count(permanency_goal, item_rating) |>
  print()


# ==============================================================================
# EXPORT TO CSV (for further analysis or graph import)
# ==============================================================================

output_dir <- "cfsr_item5_parsed_output"
dir.create(output_dir, showWarnings = FALSE)

walk2(
  result,
  names(result),
  ~ write_csv(.x, file.path(output_dir, paste0(.y, ".csv")))
)

cat("\nCSV files written to:", output_dir, "/\n")
cat("Files:", paste(list.files(output_dir), collapse = ", "), "\n")
