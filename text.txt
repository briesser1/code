# Load required library
library(stringr)

# Function to extract value sets from a CQL file
extract_valuesets <- function(file_path) {
  # Read the file
  cql_content <- readLines(file_path, warn = FALSE)
  cql_text <- paste(cql_content, collapse = "\n")
  
  # Regular expression to match valueset definitions
  # Pattern: valueset "Name": 'urn:oid:...'
  pattern <- 'valueset\\s+"([^"]+)":\\s+\'(urn:oid:[^\']+)\''
  
  # Extract all matches
  matches <- str_match_all(cql_text, pattern)[[1]]
  
  # Create data frame if matches found
  if (nrow(matches) > 0) {
    df <- data.frame(
      valueset_name = matches[, 2],
      oid = matches[, 3],
      file = basename(file_path),
      stringsAsFactors = FALSE
    )
    return(df)
  } else {
    return(data.frame(
      valueset_name = character(0),
      oid = character(0),
      file = character(0),
      stringsAsFactors = FALSE
    ))
  }
}

# Extract from both files
file1 <- "~/Desktop/CMS1154ScreeningPrediabetes-1.0.000.cql"
file2 <- "~/Desktop/CQMCommonQDM-9.0.000.cql"

valuesets1 <- extract_valuesets(file1)
valuesets2 <- extract_valuesets(file2)

# Combine results
all_valuesets <- rbind(valuesets1, valuesets2)

# Display results
cat("Total value sets found:", nrow(all_valuesets), "\n\n")
print(all_valuesets)

# Optional: Export to CSV
write.csv(all_valuesets, "valueset_oids.csv", row.names = FALSE)
cat("\nResults exported to valueset_oids.csv\n")

# Optional: Create a summary by file
cat("\n--- Summary by File ---\n")
table(all_valuesets$file)

# Optional: Extract just the OID numbers (without 'urn:oid:' prefix)
all_valuesets$oid_number <- str_replace(all_valuesets$oid, "urn:oid:", "")

# Display with clean OID numbers
print(all_valuesets[, c("valueset_name", "oid_number", "file")])
