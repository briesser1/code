
#!/usr/bin/env python3
"""
Daily Note Generator
--------------------
Creates templated daily notes with configurable structure.

Usage:
    python daily_note.py [options]

Examples:
    python daily_note.py                          # Create today's note
    python daily_note.py --date 2024-01-15        # Create note for specific date
    python daily_note.py --folder ~/notes/daily   # Specify output folder
    python daily_note.py --template custom.md     # Use custom template
"""

import argparse
from datetime import datetime, timedelta
from pathlib import Path
from string import Template


DEFAULT_TEMPLATE = """# $full_date

**Week $week_number | $day_name**

---

## Navigation

- [[Previous: $prev_date]]
- [[Next: $next_date]]

---

## Tasks

- [ ]

---

## Notes



---

## Meetings



---

## End of Day Review

### What went well?


### What could be improved?


### Tomorrow's priorities
- [ ]

---

*Created: $timestamp*
"""

MINIMAL_TEMPLATE = """# $full_date

## Tasks
- [ ]

## Notes


## Tomorrow
- [ ]
"""

WORK_TEMPLATE = """# $full_date - Work Log

**$day_name, Week $week_number**

---

## Daily Standup

### Yesterday
-

### Today
-

### Blockers
- None

---

## Time Log

| Time | Task | Notes |
|------|------|-------|
| 09:00 | | |
| 10:00 | | |
| 11:00 | | |
| 12:00 | Lunch | |
| 13:00 | | |
| 14:00 | | |
| 15:00 | | |
| 16:00 | | |
| 17:00 | | |

---

## Notes



---

## Action Items

- [ ]

---

[[← $prev_date]] | [[→ $next_date]]
"""

TEMPLATES = {
    "default": DEFAULT_TEMPLATE,
    "minimal": MINIMAL_TEMPLATE,
    "work": WORK_TEMPLATE,
}


def get_template_vars(date: datetime) -> dict:
    """Generate template variables for a given date."""
    prev_date = date - timedelta(days=1)
    next_date = date + timedelta(days=1)

    return {
        "date": date.strftime("%Y-%m-%d"),
        "full_date": date.strftime("%A, %B %d, %Y"),
        "day_name": date.strftime("%A"),
        "month": date.strftime("%B"),
        "year": date.strftime("%Y"),
        "week_number": date.strftime("%W"),
        "day_of_year": date.strftime("%j"),
        "prev_date": prev_date.strftime("%Y-%m-%d"),
        "next_date": next_date.strftime("%Y-%m-%d"),
        "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M"),
    }


def create_daily_note(
    folder: str = ".",
    date: datetime = None,
    template_name: str = "default",
    template_file: str = None,
    force: bool = False,
) -> Path:
    """
    Create a daily note file.

    Args:
        folder: Directory to create the note in
        date: Date for the note (default: today)
        template_name: Built-in template to use
        template_file: Path to custom template file
        force: Overwrite existing file if it exists

    Returns:
        Path to the created file
    """
    if date is None:
        date = datetime.now()

    # Get template content
    if template_file:
        template_path = Path(template_file).expanduser()
        if not template_path.exists():
            raise FileNotFoundError(f"Template file not found: {template_file}")
        template_content = template_path.read_text()
    else:
        template_content = TEMPLATES.get(template_name, DEFAULT_TEMPLATE)

    # Create output path
    folder_path = Path(folder).expanduser().resolve()
    folder_path.mkdir(parents=True, exist_ok=True)

    filename = date.strftime("%Y-%m-%d") + ".md"
    filepath = folder_path / filename

    # Check if file exists
    if filepath.exists() and not force:
        print(f"Note already exists: {filepath}")
        print("Use --force to overwrite")
        return filepath

    # Generate content
    vars = get_template_vars(date)
    template = Template(template_content)
    content = template.safe_substitute(vars)

    # Write file
    filepath.write_text(content)
    return filepath


def create_week_notes(
    folder: str = ".",
    start_date: datetime = None,
    template_name: str = "default",
) -> list[Path]:
    """Create notes for an entire week (Monday-Sunday)."""
    if start_date is None:
        start_date = datetime.now()

    # Find Monday of the week
    days_since_monday = start_date.weekday()
    monday = start_date - timedelta(days=days_since_monday)

    created = []
    for i in range(7):
        date = monday + timedelta(days=i)
        path = create_daily_note(folder, date, template_name)
        created.append(path)

    return created


def list_templates():
    """Print available built-in templates."""
    print("Available templates:\n")
    for name, content in TEMPLATES.items():
        # Show first few lines as preview
        preview = "\n".join(content.strip().split("\n")[:5])
        print(f"  {name}:")
        print(f"    {preview[:100]}...")
        print()


def main():
    parser = argparse.ArgumentParser(
        description="Generate daily note files from templates",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Template Variables:
  $date         - 2024-01-15
  $full_date    - Monday, January 15, 2024
  $day_name     - Monday
  $month        - January
  $year         - 2024
  $week_number  - 03
  $prev_date    - 2024-01-14
  $next_date    - 2024-01-16
  $timestamp    - 2024-01-15 09:30

Examples:
  %(prog)s                              Create today's note
  %(prog)s --date 2024-01-15            Note for specific date
  %(prog)s --template work              Use work template
  %(prog)s --week                       Create notes for entire week
  %(prog)s --folder ~/notes/daily       Specify output folder
        """,
    )
    parser.add_argument("--folder", "-f", default=".", help="Output folder (default: current)")
    parser.add_argument("--date", "-d", help="Date for note (YYYY-MM-DD, default: today)")
    parser.add_argument(
        "--template", "-t",
        default="default",
        help="Template name: default, minimal, work (default: default)",
    )
    parser.add_argument("--template-file", help="Path to custom template file")
    parser.add_argument("--force", action="store_true", help="Overwrite existing files")
    parser.add_argument("--week", "-w", action="store_true", help="Create notes for entire week")
    parser.add_argument("--list-templates", action="store_true", help="Show available templates")
    parser.add_argument("--dry-run", action="store_true", help="Show what would be created")

    args = parser.parse_args()

    if args.list_templates:
        list_templates()
        return

    # Parse date
    if args.date:
        try:
            date = datetime.strptime(args.date, "%Y-%m-%d")
        except ValueError:
            print(f"Invalid date format: {args.date}")
            print("Use YYYY-MM-DD format")
            return
    else:
        date = datetime.now()

    if args.dry_run:
        if args.week:
            days_since_monday = date.weekday()
            monday = date - timedelta(days=days_since_monday)
            print("Would create:")
            for i in range(7):
                d = monday + timedelta(days=i)
                print(f"  {d.strftime('%Y-%m-%d')}.md")
        else:
            print(f"Would create: {date.strftime('%Y-%m-%d')}.md")
        return

    if args.week:
        paths = create_week_notes(args.folder, date, args.template)
        print(f"Created {len(paths)} notes:")
        for p in paths:
            print(f"  {p}")
    else:
        path = create_daily_note(
            folder=args.folder,
            date=date,
            template_name=args.template,
            template_file=args.template_file,
            force=args.force,
        )
        print(f"Created: {path}")


if __name__ == "__main__":
    main()
